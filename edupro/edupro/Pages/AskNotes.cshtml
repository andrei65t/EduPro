@page
@model EduPro.Pages.AskNotesModel
@{
    ViewData["Title"] = "Întrebări din notițe";
    ViewData["PageTitle"] = "Pune întrebări bazate pe notițele tale";
    ViewData["PageSubtitle"] = "Selectează o categorie și pune întrebări despre notițele din acea categorie.";
}

<div class="row justify-content-center">
    <div class="col-xl-10">

        <!-- Filtru după categorii -->
        <div class="app-card mb-3">
            <div class="app-card-header">
                <div class="app-card-title">📁 Filtrează notițele după categorie</div>
            </div>
            <div class="app-card-body">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <strong>Categorie:</strong>

                    <a asp-page="/AskNotes"
                       class="btn btn-sm @(Model.SelectedCategoryId == null ? "btn-primary" : "btn-outline-primary")">
                        <i class="bi bi-grid-3x3"></i> Toate
                    </a>

                    @foreach (var category in Model.Categories)
                    {
                        <a asp-page="/AskNotes"
                           asp-route-selectedCategoryId="@category.Id"
                           class="btn btn-sm @(Model.SelectedCategoryId == category.Id ? "btn-primary" : "btn-outline-primary")"
                           style="border-left: 3px solid @category.Color;">
                            <i class="bi bi-folder"></i> @category.Name
                        </a>
                    }
                </div>

                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Filtru activ: <strong>@Model.CurrentFilter</strong> •
                        <strong>@Model.FilteredNotes.Count</strong> @(Model.FilteredNotes.Count == 1 ? "notiță disponibilă" : "notițe disponibile")
                    </small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Partea stângă: Formular întrebare -->
            <div class="col-lg-6">
                <div class="app-card mb-3">
                    <div class="app-card-header">
                        <div>
                            <div class="app-card-title">❓ Întrebare</div>
                            <div class="app-card-subtitle">
                                Căutare în @Model.FilteredNotes.Count
                                @(Model.FilteredNotes.Count == 1 ? "notiță" : "notițe")
                            </div>
                        </div>
                    </div>
                    <div class="app-card-body">
                        <form method="post">
                            <input type="hidden" name="SelectedCategoryId" value="@Model.SelectedCategoryId" />

                            <div class="mb-3">
                                <label asp-for="Question" class="form-label">Întrebarea ta</label>
                                <textarea asp-for="Question"
                                          class="form-control"
                                          rows="5"
                                          placeholder="Ex: Explică-mi conceptul de derivată din notițele mele..."
                                          required></textarea>
                                <div class="form-text">
                                    @if (Model.FilteredNotes.Any())
                                    {
                                        <i class="bi bi-lightbulb"></i>
                                        <text>Voi căuta răspunsul în toate cele @Model.FilteredNotes.Count notițe din '@Model.CurrentFilter'</text>
                                    }
                                    else
                                    {
                                        <span class="text-danger">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            Nu există notițe în categoria selectată. Schimbă categoria sau adaugă notițe noi.
                                        </span>
                                    }
                                </div>
                            </div>

                            <button type="submit"
                                    class="btn btn-primary"
                                    @(Model.FilteredNotes.Any() ? "" : "disabled")>
                                <i class="bi bi-search"></i> Caută răspunsul
                            </button>

                            @if (Model.FilteredNotes.Any())
                            {
                                <a asp-page="/NotesList"
                                   asp-route-selectedCategoryId="@Model.SelectedCategoryId"
                                   class="btn btn-outline-secondary ms-2">
                                    <i class="bi bi-list"></i> Vezi notițele
                                </a>
                            }
                        </form>
                    </div>
                </div>

                @if (Model.FilteredNotes.Any() && !Model.HasAskedQuestion)
                {
                    <div class="app-card">
                        <div class="app-card-header">
                            <div class="app-card-title">📚 Notițe disponibile</div>
                        </div>
                        <div class="app-card-body">
                            <div class="list-group">
                                @foreach (var note in Model.FilteredNotes.Take(5))
                                {
                                    <div class="list-group-item p-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-file-text text-primary me-2"></i>
                                            <div class="flex-grow-1">
                                                <div class="small fw-bold">@note.Title</div>
                                                @if (!string.IsNullOrEmpty(note.Summary))
                                                {
                                                    <div class="small text-muted">
                                                        @note.Summary.Substring(0, Math.Min(80, note.Summary.Length))...
                                                    </div>
                                                }
                                            </div>
                                            @if (note.Category != null)
                                            {
                                                <span class="badge ms-2" style="background-color: @note.Category.Color; font-size: 0.7rem;">
                                                    @note.Category.Name
                                                </span>
                                            }
                                        </div>
                                    </div>
                                }
                                @if (Model.FilteredNotes.Count > 5)
                                {
                                    <div class="list-group-item p-2 text-center bg-light">
                                        <small class="text-muted">
                                            + încă @(Model.FilteredNotes.Count - 5)
                                            @(Model.FilteredNotes.Count - 5 == 1 ? "notiță" : "notițe")
                                        </small>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Partea dreaptă: Răspuns -->
            <div class="col-lg-6">
                <div class="app-card">
                    <div class="app-card-header">
                        <div>
                            <div class="app-card-title">💡 Răspuns</div>
                            <div class="app-card-subtitle">
                                @if (Model.HasAskedQuestion)
                                {
                                    <text>Rezultatul căutării</text>
                                }
                                else
                                {
                                    <text>Așteaptă întrebarea ta</text>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="app-card-body">
                        @if (Model.HasAskedQuestion && !string.IsNullOrEmpty(Model.Answer))
                        {
                            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                            {
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle-fill"></i> @Model.ErrorMessage
                                </div>
                            }

                            <div class="alert alert-@(Model.IsFromNotes ? "success" : "warning")">
                                <h6 class="alert-heading">
                                    @if (Model.IsFromNotes)
                                    {
                                        <i class="bi bi-check-circle-fill"></i>
                                        <text>Răspuns bazat pe notițele tale</text>
                                    }
                                    else
                                    {
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        <text>Nu am găsit notițe relevante</text>
                                    }
                                </h6>
                            </div>

                            <div class="mb-3">
                                <strong class="text-bright">📝 Întrebarea ta:</strong>
                                <div class="p-2 bg-surface-alt rounded mt-1">
                                    <em class="text-soft">@Model.Question</em>
                                </div>
                            </div>

                            @if (Model.IsFromNotes && Model.SourceNotes.Any())
                            {
                                <div class="mb-3">
                                    <strong class="text-bright">📚 Surse consultate:</strong>
                                    <div class="mt-1">
                                        @foreach (var source in Model.SourceNotes)
                                        {
                                            <span class="badge bg-primary me-1 mb-1">@source</span>
                                        }
                                    </div>
                                </div>
                            }

                            <div>
                                <strong class="text-bright">💬 Răspuns:</strong>
                                <div class="mt-2 p-3 response-box" style="white-space: pre-wrap;">@Model.Answer</div>
                            </div>

                            <div class="mt-3">
                                <a asp-page="/AskNotes"
                                   asp-route-selectedCategoryId="@Model.SelectedCategoryId"
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-arrow-counterclockwise"></i> Pune altă întrebare
                                </a>
                            </div>
                        }
                        else
                        {
                            <div class="border-soft rounded-3 p-4 bg-surface-alt text-center">
                                <i class="bi bi-chat-dots text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-3 mb-2">
                                    <strong>Cum funcționează:</strong>
                                </p>
                                <ol class="text-start text-muted small">
                                    <li>Selectează o categorie din butoanele de mai sus</li>
                                    <li>Scrie întrebarea ta în câmpul din stânga</li>
                                    <li>Click pe "Caută răspunsul"</li>
                                    <li>Primești un răspuns bazat pe toate notițele din categoria selectată</li>
                                </ol>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>